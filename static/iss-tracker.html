<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ISS Orbital Tracker</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #dashboard {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 2;
            background: rgba(15, 20, 30, 0.55);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            width: 320px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        h1 {
            margin: 0 0 16px 0;
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #4da8da;
        }
        .metric {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }
        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .label {
            font-size: 0.85rem;
            color: #a0aab5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .value {
            font-size: 1.1rem;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #2ecc71;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px #2ecc71;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(46, 204, 113, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            font-size: 1.2rem;
            letter-spacing: 2px;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">INITIALIZING ORBITAL TRACKER...</div>

    <div id="dashboard">
        <h1><span class="live-indicator"></span>ISS Telemetry</h1>
        <div class="metric">
            <span class="label">Latitude</span>
            <span class="value" id="lat-val">--.----째</span>
        </div>
        <div class="metric">
            <span class="label">Longitude</span>
            <span class="value" id="lon-val">--.----째</span>
        </div>
        <div class="metric">
            <span class="label">Altitude</span>
            <span class="value" id="alt-val">-- km</span>
        </div>
        <div class="metric">
            <span class="label">Velocity</span>
            <span class="value" id="vel-val">-- km/h</span>
        </div>
        <div class="metric">
            <span class="label">Solar Point</span>
            <span class="value" id="solar-val">Tracking</span>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- Core Scene Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 15, 40);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // Physically correct lighting
        renderer.useLegacyLights = false; 
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 12;
        controls.maxDistance = 100;

        // --- Post-Processing (Bloom) ---
        const renderScene = new RenderPass(scene, camera);
        // Resolution, strength, radius, threshold
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2;
        bloomPass.strength = 1.2;
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- Earth Setup ---
        const earthRadius = 10;
        const textureLoader = new THREE.TextureLoader();
        
        // High-res Blue Marble textures (using reliable public CDNs)
        const earthMap = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg', () => {
            document.getElementById('loading').style.opacity = '0';
        });
        const earthBump = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png');
        const earthSpec = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png');

        const earthGeometry = new THREE.SphereGeometry(earthRadius, 64, 64);
        const earthMaterial = new THREE.MeshStandardMaterial({
            map: earthMap,
            bumpMap: earthBump,
            bumpScale: 0.1,
            roughnessMap: earthSpec,
            roughness: 0.6,
            metalness: 0.1
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        scene.add(earth);

        // Ambient Light (very dim, just to see the dark side slightly)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.05);
        scene.add(ambientLight);

        // --- Real-Time Solar Ephemeris (Directional Light) ---
        const sunLight = new THREE.DirectionalLight(0xffffee, 3.0);
        scene.add(sunLight);

        function updateSolarPosition() {
            const now = new Date();
            const start = new Date(now.getUTCFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);

            // Fractional UTC hours
            const utcHours = now.getUTCHours() + now.getUTCMinutes() / 60 + now.getUTCSeconds() / 3600;

            // Earth's axial tilt (~23.44 degrees)
            const tilt = 23.44 * (Math.PI / 180);
            // Solar declination approximation
            const declination = tilt * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));

            // Solar longitude mapping to Three.js coordinates
            // 12:00 UTC puts the sun over the Prime Meridian (0 longitude)
            const sunLon = (12 - utcHours) * 15 * (Math.PI / 180);

            // Convert to Cartesian (x, y, z)
            const distance = 100;
            const x = distance * Math.cos(declination) * Math.cos(sunLon);
            const z = -distance * Math.cos(declination) * Math.sin(sunLon);
            const y = distance * Math.sin(declination);

            sunLight.position.set(x, y, z);
            sunLight.lookAt(0, 0, 0);
        }

        // --- ISS Setup (Glass-morphic Beacon) ---
        const issGeometry = new THREE.SphereGeometry(0.15, 16, 16);
        const issMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x00ffff,
            emissive: 0x00ffff,
            emissiveIntensity: 2.5, // High intensity triggers the UnrealBloomPass
            transmission: 0.9,      // Glass-like
            opacity: 1,
            metalness: 0.2,
            roughness: 0.1,
            ior: 1.5,
            thickness: 0.5
        });
        const issMesh = new THREE.Mesh(issGeometry, issMaterial);
        scene.add(issMesh);

        // Coordinate Conversion Helper
        function latLongToVector3(lat, lon, radius, heightOffset) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);

            const r = radius + heightOffset;

            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const z = (r * Math.sin(phi) * Math.sin(theta));
            const y = (r * Math.cos(phi));

            return new THREE.Vector3(x, y, z);
        }

        // --- Data Fetching & UI Updates ---
        const UI = {
            lat: document.getElementById('lat-val'),
            lon: document.getElementById('lon-val'),
            alt: document.getElementById('alt-val'),
            vel: document.getElementById('vel-val')
        };

        async function fetchISSData() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();

                // Update UI Dashboard
                UI.lat.innerText = `${data.latitude.toFixed(4)}째`;
                UI.lon.innerText = `${data.longitude.toFixed(4)}째`;
                UI.alt.innerText = `${data.altitude.toFixed(2)} km`;
                
                // Calculated velocity metric formatting
                UI.vel.innerText = `${Math.round(data.velocity).toLocaleString()} km/h`;

                // Update 3D Position
                // Exaggerate altitude slightly for visibility (scale down earth radius roughly)
                const heightScale = data.altitude / 6371; // Earth radius is ~6371km
                const targetPos = latLongToVector3(data.latitude, data.longitude, earthRadius, heightScale * earthRadius);
                
                // Smooth interpolation could be added here, but direct set is accurate to the 5s tick
                issMesh.position.copy(targetPos);

            } catch (error) {
                console.error("Failed to fetch ISS data:", error);
            }
        }

        // Initial fetch and solar position
        fetchISSData();
        updateSolarPosition();

        // 5-second asynchronous polling loop
        setInterval(() => {
            fetchISSData();
            updateSolarPosition(); // Keep solar positioning highly accurate over time
        }, 5000);

        // --- Animation & Resize Handling ---
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            composer.render(); // Use composer instead of renderer for bloom
        }

        animate();
    </script>
</body>
</html>
